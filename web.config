<?xml version="1.0" encoding="utf-8"?>
<configuration>
  <system.webServer>

    <rewrite>
      <rules>

        <!-- 0) Force HTTPS (optional; keep if you want HSTS-lean behavior) -->
        <rule name="Redirect to HTTPS" enabled="true" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>

        <!-- 1) API proxy: /api/* -> Node API on loopback -->
        <rule name="API Proxy" stopProcessing="true">
          <match url="^api/(.*)" />
          <!-- If your backend expects /api prefix internally, keep /api/{R:1}; 
               if it expects no prefix, use http://127.0.0.1:4001/{R:1} -->
          <action type="Rewrite" url="http://127.0.0.1:4001/api/{R:1}" logRewrittenUrl="true" />
        </rule>

        <!-- 2) SPA fallback: non-file, non-dir, not /api -> index.html -->
        <rule name="SPA Fallback" stopProcessing="true">
          <match url=".*" />
          <conditions logicalGrouping="MatchAll">
            <add input="{REQUEST_FILENAME}" matchType="IsFile" negate="true" />
            <add input="{REQUEST_FILENAME}" matchType="IsDirectory" negate="true" />
            <add input="{REQUEST_URI}" pattern="^/api/" negate="true" />
          </conditions>
          <action type="Rewrite" url="/index.html" />
        </rule>

      </rules>
      <!-- Optional outbound rules for CORS can go here, but prefer to set CORS in backend -->
    </rewrite>

    <!-- Static caching for built assets (tune durations as needed) -->
    <staticContent>
      <remove fileExtension=".json" />
      <mimeMap fileExtension=".json" mimeType="application/json" />
    </staticContent>

    <httpProtocol>
      <customHeaders>
        <!-- Basic security headers (adjust to your org policy) -->
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="Referrer-Policy" value="no-referrer" />
        <!-- Add CSP after you audit all external resources used by the app -->
        <!-- <add name="Content-Security-Policy" value="default-src 'self'; img-src 'self' data:; script-src 'self'; style-src 'self' 'unsafe-inline'"> -->
      </customHeaders>
    </httpProtocol>

    <caching enabled="true">
      <!-- Cache hashed assets aggressively -->
      <profiles>
        <add extension=".js" policy="CacheForTimePeriod" duration="7.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
        <add extension=".css" policy="CacheForTimePeriod" duration="7.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
        <add extension=".svg" policy="CacheForTimePeriod" duration="30.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
        <add extension=".png" policy="CacheForTimePeriod" duration="30.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
        <add extension=".jpg" policy="CacheForTimePeriod" duration="30.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
        <add extension=".woff2" policy="CacheForTimePeriod" duration="30.00:00:00" kernelCachePolicy="CacheForTimePeriod" />
      </profiles>
    </caching>

    <!-- Compression (if not globally configured) -->
    <!-- <urlCompression doStaticCompression="true" doDynamicCompression="true" /> -->

  </system.webServer>
</configuration>
